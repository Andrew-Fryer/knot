#!/bin/sh

TESTS_DIR="@abs_srcdir@/cases"
OUTS_DIR="@abs_builddir@/zscanner_tests"
TEST_BIN="@builddir@/../zscanner-tool -m 2"

trap "chmod -R u+rw ${OUTS_DIR} && rm -rf ${OUTS_DIR}" EXIT

if [ $# -eq 0 ]; then
    RESULT_DIR=`mktemp -d /tmp/zscanner_tests.XXXX`
    echo "ZSCANNER TEST ${RESULT_DIR}"
fi

# Create output directory and copy include zone files.
mkdir -p "${OUTS_DIR}/cases"
cp -r "${TESTS_DIR}/includes" "${OUTS_DIR}"

# Run zscanner on all test zone files.
for file in $( (find "${TESTS_DIR}" -name "*.in"; find "@builddir@/../zscanner/test/cases" -name "*.in") | sort -n); do
    fileout="$(basename "${file}" .in).out"

    # Run zscanner.
    ${TEST_BIN} . "${file}" > "${OUTS_DIR}/${fileout}"

    # Compare result with a reference one.
    cmp -s "${OUTS_DIR}/${fileout}" "${fileout}"

    RET=$?

    # Check for differences.
    if [ $RET -ne 0 ]; then
        # If verbose print diff.
	if [ $# -eq 0 ]; then
	    echo "\n=== ${fileout} DIFF ======================"
	    diff "${OUTS_DIR}/${fileout}" "${fileout}"
	fi
    fi
done

if [ $# -eq 0 ]; then
    mv "${OUTS_DIR}" "${RESULT_DIR}"
    echo "\nFINISHED ${RESULT_DIR}"
fi
